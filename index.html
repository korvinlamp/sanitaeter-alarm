<script>
  const guideSteps = [
    { id: "start", title: "Eigenschutz beachten!", options: [{ text: "Weiter", next: "ansprechen" }] },
    {
      id: "ansprechen",
      title: "Reagiert der Patient auf Ansprechen - Anfassen?",
      options: [
        { text: "Ja, er reagiert", next: "reagiert" },
        { text: "Nein, er reagiert NICHT", next: "atmenPruefen" }
      ]
    },
    {
      id: "reagiert",
      title: "Bleibe ruhig, die Sanitäter sind alarmiert.",
      content: `<ul>
        <li>Versorge lebensbedrohliche Verletzungen</li>
        <li>Wird der Rettungsdienst benötigt? ➡ Notruf 112</li>
        <li>Betreue den Patienten</li>
        <li>Denke an den Wärmeerhalt</li>
      </ul>`,
      options: []
    },
    {
      id: "atmenPruefen",
      title: "Prüfe 10 Sekunden, ob der Patient atmet.",
      content: `<ul>
        <li>Patient liegt auf dem Rücken</li>
        <li>Oberkörper ist entkleidet</li>
        <li>Kopf ist überstreckt</li>
      </ul>`,
      options: [
        { text: "Ja, der Patient atmet", next: "seitenlage" },
        { text: "Nein, der Patient atmet NICHT", next: "notruf" }
      ]
    },
    {
      id: "notruf",
      title: "Lasse den Notruf unter 112 absetzen und lasse den Defibrillator (AED) holen.",
      options: [{ text: "Weiter", next: "druckpunkt" }]
    },
    {
      id: "druckpunkt",
      title: "Starte Wiederbelebung",
      content: `
        <p><strong>Druckpunkt:</strong> mittig, zwischen den Brustwarzen</p>
        <ul>
          <li><strong>30x</strong> 5 cm tief eindrücken + vollständig entlasten</li>
          <li><strong>2x</strong> beatmen: Kopf überstrecken, Nase zuhalten, in den Mund beatmen</li>
          <li>(Defibrillator einschalten + Anweisungen folgen)</li>
        </ul>
        <button id="metronomeBtn" class="primary">▶ Metronom starten (100 BPM)</button>
      `,
      options: []
    },
    {
      id: "seitenlage",
      title: "Lege den Patienten in die stabile Seitenlage.",
      options: [{ text: "Weiter", next: "notruf2" }]
    },
    {
      id: "notruf2",
      title: "Lasse den Notruf unter 112 absetzen und lasse den Defibrillator (AED) holen.",
      options: [{ text: "Weiter", next: "timer" }]
    },
    {
      id: "timer",
      title: "Atmung in 2 Minuten 30 erneut überprüfen",
      content: `<p id="countdown">⏳ Atmung erneut überprüfen in: 2:30</p>
                <button onclick="showStep('atmenPruefen')" class="primary">Atmung überprüfen</button>`,
      options: []
    },
    {
      id: "atmungCheck",
      title: "<span class='blink'>ATEMUNG ÜBERPRÜFEN</span>",
      options: [
        { text: "Atmung überprüfen", next: "atmenPruefen" }
      ]
    }
  ];

  let stepHistory = [];
  let countdownInterval;
  const metronomeAudio = new Audio("/mnt/data/Metronome 110 BPM - For CPR Training - Chest Compression Rate #listenable #cpr.mp3");
  metronomeAudio.loop = true;

  function showStep(stepId) {
    clearInterval(countdownInterval);
    const step = guideSteps.find(s => s.id === stepId);
    if (!step) return;

    document.getElementById("stepTitle").innerHTML = step.title;
    document.getElementById("stepContent").innerHTML = step.content || "";
    document.getElementById("stepActions").innerHTML = "";

    step.options.forEach(opt => {
      const btn = document.createElement("button");
      btn.className = "primary";
      btn.innerText = opt.text;
      btn.onclick = () => {
        stepHistory.push(stepId);
        showStep(opt.next);
      };
      document.getElementById("stepActions").appendChild(btn);
    });

    document.getElementById("backBtn").classList.toggle("hidden", stepHistory.length === 0);

    if (stepId === "druckpunkt") {
      setTimeout(() => {
        const btn = document.getElementById("metronomeBtn");
        if (btn) btn.addEventListener("click", toggleMetronome);
      }, 100);
    }

    if (stepId === "timer") startCountdown(150);
  }

  function startCountdown(seconds) {
    const display = document.getElementById("countdown");
    countdownInterval = setInterval(() => {
      const min = Math.floor(seconds / 60);
      const sec = seconds % 60;
      display.textContent = `⏳ Atmung erneut überprüfen in: ${min}:${sec < 10 ? '0' : ''}${sec}`;
      if (seconds <= 0) {
        clearInterval(countdownInterval);
        showStep("atmungCheck");
      }
      seconds--;
    }, 1000);
  }

  function toggleMetronome(e) {
    const btn = e.target;
    if (!metronomeAudio.paused) {
      metronomeAudio.pause();
      metronomeAudio.currentTime = 0;
      btn.textContent = "▶ Metronom starten (100 BPM)";
    } else {
      metronomeAudio.play();
      btn.textContent = "⏹ Metronom stoppen";
    }
  }

  document.getElementById("alarmForm").addEventListener("submit", function(e) {
    e.preventDefault();
    document.getElementById("alarmForm").classList.add("hidden");
    document.getElementById("postAlarm").classList.remove("hidden");
  });

  document.getElementById("startGuide").addEventListener("click", function() {
    document.getElementById("postAlarm").classList.add("hidden");
    document.getElementById("guide").classList.remove("hidden");
    showStep("start");
  });

  document.getElementById("backBtn").addEventListener("click", function() {
    const prevStep = stepHistory.pop();
    if (prevStep) showStep(prevStep);
  });
</script>
